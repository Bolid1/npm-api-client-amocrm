<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: libs/clients/api-v2.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: libs/clients/api-v2.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import _ from 'underscore';
import AmoApiClient from './api';

/**
 * @classdesc Client for api v2 of amoCRM
 * @class AmoV2ApiClient
 */
export default class AmoV2ApiClient extends AmoApiClient {
  /**
   * @param {RequesterClass} request
   * @param {PromoClientClass} promoClient
   */
  constructor(request, promoClient) {
    super(request, promoClient);
    let elementsPaths = {
      'companies/list': 'private/api/v2/json/companies/list/',
      'companies/set': 'private/api/v2/json/company/set/',
    };

    _.each(['contacts', 'leads', 'tasks', 'notes'], (entity) => {
      elementsPaths[`${entity}/list`] = `private/api/v2/json/${entity}/list/`;
      elementsPaths[`${entity}/set`] = `private/api/v2/json/${entity}/set/`;
    });

    // noinspection JSAccessibilityCheck
    _.extend(this._pathMatch, elementsPaths);

    _.each(_.keys(elementsPaths), (path) => {
      let entity;
      let method;
      let entityCamel;

      [entity, method] = path.split('/');
      entityCamel = entity.substr(0, 1).toUpperCase() + entity.substr(1);

      switch (method) {
        case 'list':
          this[`${method}${entityCamel}`] = this._buildListMethod(entity);
          break;
        case 'set':
          this[`${method}${entityCamel}`] = this._buildSetMethod(entity);
          this[`add${entityCamel}`] = this._buildAddMethod(entity);
          this[`update${entityCamel}`] = this._buildUpdateMethod(entity);
          break;
      }
    }, this);
  }

  /**
   * @description Get list of companies
   * @method listCompanies
   * @memberOf AmoV2ApiClient
   * @instance
   * @public
   * @param {Object} [qs]
   * @return {Promise}
   */

  /**
   * @description Add companies
   * @method addCompanies
   * @memberOf AmoV2ApiClient
   * @instance
   * @public
   * @param {Array} companies
   * @return {Promise}
   */

  /**
   * @description Update companies
   * @method updateCompanies
   * @memberOf AmoV2ApiClient
   * @instance
   * @public
   * @param {Array} companies
   * @return {Promise}
   */

  /**
   * @description Execute set method of companies
   * @method setCompanies
   * @memberOf AmoV2ApiClient
   * @instance
   * @public
   * @param {Object} data
   * @param {Array} [data.add]
   * @param {Array} [data.update]
   * @param {Object} [qs]
   * @return {Promise}
   */

  /**
   * @description Get list of contacts
   * @method listContacts
   * @memberOf AmoV2ApiClient
   * @instance
   * @public
   * @param {Object} [qs]
   * @return {Promise}
   */

  /**
   * @description Add contacts
   * @method addContacts
   * @memberOf AmoV2ApiClient
   * @instance
   * @public
   * @param {Array} contacts
   * @return {Promise}
   */

  /**
   * @description Update contacts
   * @method updateContacts
   * @memberOf AmoV2ApiClient
   * @instance
   * @public
   * @param {Array} contacts
   * @return {Promise}
   */

  /**
   * @description Execute set method of contacts
   * @method setContacts
   * @memberOf AmoV2ApiClient
   * @instance
   * @public
   * @param {Object} data
   * @param {Array} [data.add]
   * @param {Array} [data.update]
   * @param {Object} [qs]
   * @return {Promise}
   */

  /**
   * @description Get list of leads
   * @method listLeads
   * @memberOf AmoV2ApiClient
   * @instance
   * @public
   * @param {Object} [qs]
   * @return {Promise}
   */

  /**
   * @description Add leads
   * @method addLeads
   * @memberOf AmoV2ApiClient
   * @instance
   * @public
   * @param {Array} leads
   * @return {Promise}
   */

  /**
   * @description Update leads
   * @method updateLeads
   * @memberOf AmoV2ApiClient
   * @instance
   * @public
   * @param {Array} leads
   * @return {Promise}
   */

  /**
   * @description Execute set method of leads
   * @method setLeads
   * @memberOf AmoV2ApiClient
   * @instance
   * @public
   * @param {Object} data
   * @param {Array} [data.add]
   * @param {Array} [data.update]
   * @param {Object} [qs]
   * @return {Promise}
   */

  /**
   * @description Get list of tasks
   * @method listTasks
   * @memberOf AmoV2ApiClient
   * @instance
   * @public
   * @param {Object} [qs]
   * @return {Promise}
   */

  /**
   * @description Add tasks
   * @method addTasks
   * @memberOf AmoV2ApiClient
   * @instance
   * @public
   * @param {Array} tasks
   * @return {Promise}
   */

  /**
   * @description Update tasks
   * @method updateTasks
   * @memberOf AmoV2ApiClient
   * @instance
   * @public
   * @param {Array} tasks
   * @return {Promise}
   */

  /**
   * @description Execute set method of tasks
   * @method setTasks
   * @memberOf AmoV2ApiClient
   * @instance
   * @public
   * @param {Object} data
   * @param {Array} [data.add]
   * @param {Array} [data.update]
   * @param {Object} [qs]
   * @return {Promise}
   */

  /**
   * @description Get list of notes
   * @method listNotes
   * @memberOf AmoV2ApiClient
   * @instance
   * @public
   * @param {Object} [qs]
   * @return {Promise}
   */

  /**
   * @description Add notes
   * @method addNotes
   * @memberOf AmoV2ApiClient
   * @instance
   * @public
   * @param {Array} notes
   * @return {Promise}
   */

  /**
   * @description Update notes
   * @method updateNotes
   * @memberOf AmoV2ApiClient
   * @instance
   * @public
   * @param {Array} notes
   * @return {Promise}
   */

  /**
   * @description Execute set method of notes
   * @method setNotes
   * @memberOf AmoV2ApiClient
   * @instance
   * @public
   * @param {Object} data
   * @param {Array} [data.add]
   * @param {Array} [data.update]
   * @param {Object} [qs]
   * @return {Promise}
   */

  /**
   * @param {string} entity
   * @param {boolean} [checkPagination]
   * @return {function(*)}
   * @protected
   * @override
   * @memberOf AmoV2ApiClient
   * @instance
   */
  _buildListMethod(entity, checkPagination) {
    return (qs, withPagination) => {
      return new Promise((resolve, reject) => {
        this._get(`${entity}/list`, qs).then((res) => {
            if (!res[entity]) {
              return reject(res);
            }

            if (checkPagination === true &amp;&amp; withPagination === true) {
              return resolve(res);
            }

            return resolve(res[entity]);
          },
          reject
        );
      });
    };
  }

  /**
   * @param {string} entity
   * @return {function(*)}
   * @protected
   * @memberOf AmoV2ApiClient
   * @instance
   */
  _buildSetMethod(entity) {
    return (data, qs) => {
      return new Promise((resolve, reject) => {
        let form = {request: {}};
        form.request[entity] = data;

        this._post(`${entity}/set`, form, qs).then(
          (resp) => this._resolveAction(null, entity, resp, resolve, reject),
          reject
        );
      });
    };
  }

  /**
   * @param {string|null} action
   * @param {string|null} entity
   * @param {Object} resp
   * @param {function} resolve
   * @param {function} reject
   * @param {boolean} [keepErrors]
   * @return {*}
   * @protected
   * @memberOf AmoV2ApiClient
   * @instance
   */
  _resolveAction(action, entity, resp, resolve, reject, keepErrors) {
    if (action === null &amp;&amp; entity !== null) {
      action = entity;
      entity = null;
    }

    if (!resp[action]) {
      return reject(resp);
    }

    if (entity !== null) {
      if (_.has(resp[action], entity) &amp;&amp; _.has(resp[action], 'errors')) {
        if (keepErrors !== true) {
          return resolve(resp[action][entity]);
        }
      }
    }


    return resolve(resp[action]);
  }

  /**
   * @param {string} entity
   * @param {boolean} [checkErrors]
   * @return {function(*)}
   * @protected
   * @memberOf AmoV2ApiClient
   * @instance
   */
  _buildAddMethod(entity, checkErrors) {
    return this._buildActionMethod('add', entity, checkErrors);
  }

  /**
   * @param {string} entity
   * @param {boolean} [checkErrors]
   * @return {function(*)}
   * @protected
   * @memberOf AmoV2ApiClient
   * @instance
   */
  _buildUpdateMethod(entity, checkErrors) {
    return this._buildActionMethod('update', entity, checkErrors);
  }

  /**
   * @param {string} action
   * @param {string} entity
   * @param {boolean} [checkErrors]
   * @return {function(*)}
   * @protected
   * @memberOf AmoV2ApiClient
   * @instance
   */
  _buildActionMethod(action, entity, checkErrors) {
    return (elements, saveErrorsInResponse) => {
      let entityCamel = entity.substr(0, 1).toUpperCase() + entity.substr(1);
      let form = {};
      form[action] = elements;

      return new Promise((resolve, reject) => {
        this[`set${entityCamel}`](form).then(
          (resp) => this._resolveAction(
            action,
            entity,
            resp,
            resolve,
            reject,
            checkErrors === true &amp;&amp; saveErrorsInResponse === true
          ),
          reject
        );
      });
    };
  }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AmoApiClient.html">AmoApiClient</a></li><li><a href="AmoV2ApiClient.html">AmoV2ApiClient</a></li><li><a href="AmoV3ApiClient.html">AmoV3ApiClient</a></li><li><a href="module.html#.exports">exports</a></li><li><a href="PromoClientClass.html">PromoClientClass</a></li><li><a href="RequesterClass.html">RequesterClass</a></li></ul><h3>Global</h3><ul><li><a href="global.html#ACCOUNT_INFO_STATUSES">ACCOUNT_INFO_STATUSES</a></li><li><a href="global.html#ACCOUNT_INFO_TOP_DOMAIN">ACCOUNT_INFO_TOP_DOMAIN</a></li><li><a href="global.html#getApiV2Client">getApiV2Client</a></li><li><a href="global.html#getPromoClient">getPromoClient</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Fri Mar 24 2017 19:43:26 GMT+0300 (Russia TZ 2 Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
