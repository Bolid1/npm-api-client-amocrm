<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: libs/helpers/requester.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: libs/helpers/requester.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import request from 'request';
import _ from 'underscore';

export const slowdownTime = 1000;

/**
 * @classdesc Request client for amoCRM
 */
export class RequesterClass {
  /**
   * @constructor
   * @param {request} request
   * @param {Object} [params]
   * @param {number} [params.slowdownTime]
   */
  constructor(request, params) {
    params || (params = {});

    /**
     * @type {request}
     * @private
     */
    this._request = request;

    /**
     * @type {number}
     * @private
     */
    this._lastRequestAt = 0;

    /**
     * @type {number}
     * @private
     */
    this._slowdownTime = slowdownTime;
    if (typeof params.slowdownTime !== 'undefined') {
      this._slowdownTime = params.slowdownTime;
    }

    this._queueCount = 0;
  }

  /**
   * @private
   */
  _markRequestTime() {
    this._lastRequestAt = +new Date;
  }

  /**
   * @return {number}
   * @private
   */
  _getTimeFromLastRequest() {
    return (+new Date - this._lastRequestAt);
  }

  /**
   * @description Proxy method for defaults
   * @param {Object} params
   * @return {RequesterClass}
   */

  /**
   * @description Make cookie handler
   * @param {*} [store]
   * @return {RequestJar}
   */
  jar(store) {
    return this._request.jar(store);
  }

  /**
   * @param {string|Object} uri
   * @param {Object|function} options
   * @param {function} [callback]
   */
  get(uri, options, callback) {
    this._makeRequest('get', uri, options, callback);
  }

  /**
   * @param {string|Object} uri
   * @param {Object|function} options
   * @param {function} [callback]
   */
  post(uri, options, callback) {
    this._makeRequest('post', uri, options, callback);
  }

  /**
   * @param {string} type
   * @param {string} uri
   * @param {Object} options
   * @param {function} callback
   */
  _makeRequest(type, uri, options, callback) {
    let timeFromLastRequest = this._getTimeFromLastRequest();
    let delay;

    this._start = this._start || +new Date;

    if (timeFromLastRequest &lt; this._slowdownTime) {
      ++this._queueCount;

      delay = this._queueCount * this._slowdownTime;
      delay += timeFromLastRequest + this._queueCount * 10;

      _.delay(
        _.bind(this[type], this, uri, options, callback),
        delay
      );
      return;
    }

    this._markRequestTime();

    if (this._queueCount > 0) {
      --this._queueCount;
    }

    this._request[type](uri, options, callback);
  }
}

export default new RequesterClass(request);
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AmoApiClient.html">AmoApiClient</a></li><li><a href="AmoV2ApiClient.html">AmoV2ApiClient</a></li><li><a href="AmoV3ApiClient.html">AmoV3ApiClient</a></li><li><a href="PromoClientClass.html">PromoClientClass</a></li><li><a href="RequesterClass.html">RequesterClass</a></li></ul><h3>Global</h3><ul><li><a href="global.html#ACCOUNT_INFO_STATUSES">ACCOUNT_INFO_STATUSES</a></li><li><a href="global.html#ACCOUNT_INFO_TOP_DOMAIN">ACCOUNT_INFO_TOP_DOMAIN</a></li><li><a href="global.html#getApiV2Client">getApiV2Client</a></li><li><a href="global.html#getApiV3Client">getApiV3Client</a></li><li><a href="global.html#getPromoClient">getPromoClient</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Mon Mar 27 2017 12:13:51 GMT+0300 (Russia TZ 2 Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
